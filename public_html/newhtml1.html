<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <title>Simple Map</title>
        <meta name="viewport" content="initial-scale=1.0">
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="">
        
        <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->

        <link rel="stylesheet" href="css/normalize.css">
 
        <link rel="stylesheet" href="css/main.css">
        <script src="js/vendor/modernizr-2.6.2.min.js"></script>
        
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
      
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <!-- Add your site or application content here -->
        <div id="map"></div>
        
        
        <div id="streetViewer">
            
        </div>
        <div id="tools">
            <h2>Options</h2>
            <label>  View Mode
               <select id="viewModeSelect">
                   <option selected value="nearest">Only Show Nearest</option>
                   <option value="all">Show All</option>
               </select>
            </label><br>
           
            <label>
                <input type="checkbox" id="showReservedCheckBox" value="first_checkbox">
                Show Reserved Spaces
            </label><br>    
            <h3>remove jquery, upload to git, create readme, add google api setup steps to readme</h3>
        </div>
        <script>
            var map = {};
            var mode = "nearest";
            var lat = 37.7509
            var lng = -122.4394;
            var startingLocation = null;
            var panorama = null;
            var showReserved = false;
            var destinationString = '';
            var destinations = [];
            
            function initMap() {
             
            startingLocation = new google.maps.LatLng(lat,lng);
          
              
            map = new google.maps.Map(document.getElementById('map'), {
              center: startingLocation,
              zoom: mode==="nearest"?15:13,
                 
            });
            
            //destinationString = '&origins='+startingLocation.lat()+','+startingLocation.lng()+'&destinations=';
        
            map.openInfoWindow = null;
      
            var myLocationMarker = new google.maps.Marker({
              position: startingLocation,
              map: map,
              title: 'You are here',
              icon: {
                  path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
                  scale: 5,
                  strokeColor: 'blue',
                  strokeWeight: 2,
                  fillColor: 'yellow',
                  fillOpacity: 0.6
                },
              draggable: true

            });
            
            myLocationMarker.addListener("dragend", function(event) {
                moveMarkerEvent(event);
            });
            
            var url;
            if(mode === "nearest")
                url = 'http://ridecellparking.herokuapp.com/api/v1/parkinglocations/search?lat='+startingLocation.lat()+'&lng='+startingLocation.lng()+'&format=json'
            else
                url = 'http://ridecellparking.herokuapp.com/api/v1/parkinglocations?format=json'
            
            $.getJSON(url, function(data) {
 
            
                for (var i = 0, max = data.length; i < max; i++) {
                     var spotLocation = {lat: parseFloat(data[i].lat), lng: parseFloat(data[i].lng)};  
                     
                     //destinationString += data[i].lat+','+data[i].lng+'|';
                      destinations.push( new google.maps.LatLng(parseFloat(data[i].lat),parseFloat(data[i].lng)))     



 
                    var image = 'img/icon.png';
                    if(data[i].is_reserved)
                        image = 'img/icon_red.png';
                    if(showReserved || !data[i].is_reserved) {
                        
                        var spotMarker = new google.maps.Marker({
                            position: spotLocation,
                            map: map,
                            title: data[i].is_reserved?'Spot '+data[i].name+' is reserved.':'Spot '+data[i].name+' costs $'+data[i].cost_per_minute+'/min',
                            icon: data[i].is_reserved?'img/icon_red.png':'img/icon.png',
                            draggable: false
                        });
                    
                        spotMarker.id = i;
                        spotMarker.rideCellData = data[i];
                     // Event Handlers
                        spotMarker.addListener('click', function(event) {
                            var sp = this;
                        var contentString = 
                           '<div id="content">'+
                               '<label>Spot Name:&nbsp;<span>'+this.rideCellData.name+'</span></label><br>'+
                               '<label>Spot Number:&nbsp;<span>'+this.rideCellData.id+'</span></label><br>'+
                               '<label>Cost Per Minute:&nbsp;<span>$'+this.rideCellData.cost_per_minute+'</span></label><br>'+
                               '<input id="reserve'+this.rideCellData.id+'" onclick="javascript:clickedButton('+this.rideCellData.id+');return false;" type="button" value="Reserve This Spot" /><br>';

var service = new google.maps.DistanceMatrixService();
service.getDistanceMatrix(
  {
    origins: [new google.maps.LatLng(lat, lng)],
    destinations: [ this.position ],
    travelMode: google.maps.TravelMode.DRIVING,
   //transitOptions: TransitOptions,
   // drivingOptions: DrivingOptions,
    unitSystem: google.maps.UnitSystem.IMPERIAL,
   // avoidHighways: Boolean,
   // avoidTolls: Boolean,
  }, callback);

function callback(response, status) {
    
    sp.rideCellData.address = response.destinationAddresses[0];
    sp.rideCellData.distance = response.rows[0].elements[0].distance.text;
    sp.rideCellData.duration = response.rows[0].elements[0].duration.text;
    
     contentString = '<div id="content">'+
                               '<label>Spot Name:&nbsp;<span>'+sp.rideCellData.name+'</span></label><br>'+
                               '<label>Spot Number:&nbsp;<span>'+sp.rideCellData.id+'</span></label><br>'+
                               '<label>Cost Per Minute:&nbsp;<span>$'+sp.rideCellData.cost_per_minute+'</span></label><br>'+
                               '<input id="reserve'+sp.rideCellData.id+'" onclick="javascript:clickedButton('+sp.rideCellData.id+');return false;" type="button" value="Reserve This Spot" /><br>'+
                              '<label>Distance:&nbsp;<span>'+sp.rideCellData.distance+'</span></label>&nbsp;'+
                        '<label>Drivetime:&nbsp;<span>'+ sp.rideCellData.duration+'</span></label></div>'  ;    
                        

                    var infowindow = new google.maps.InfoWindow({
                      content: contentString,
                      position:spotLocation
                    });

                            infowindow.open(map, sp);
                            map.openInfoWindow = infowindow;
                           
                            $("#infowindow").append(createSelectForTime(sp.id, data[sp.id].min_reserve_time_mins,data[sp.id].max_reserve_time_mins))
                           
                            panorama = new google.maps.StreetViewPanorama(document.getElementById('streetViewer'), 
                            {position: sp.position});
} 

                            
 




                
                        });  
                        
                        spotMarker.addListener('close', function() {
                             map.openInfoWindow = null;
                         });                     

                        
                    }
                }
         

                    
         
            });
            
        
            
            $("#viewModeSelect").change( function() {
                mode = $("#viewModeSelect").val();
                lat = 37.7509
                lng = -122.4394;
                initMap();
            });
            
             $("#showReservedCheckBox").change( function(event) {
                if(event.target.checked)
                    showReserved = true;
                else 
                    showReserved = false;
                
                initMap();
             });
           
            
            map.addListener('click', function(event) {
                if(map.openInfoWindow !== null) {
                   map.openInfoWindow.close();
                }
                
                if(panorama !== null) { 
                    panorama.setVisible(false);
                    panorama = null;
                }

                moveMarkerEvent(event);
            });
          }
          
          function testFunction(data) {
              alert(data);
          }          
          function clickedButton(id) {
              alert(id);
          }
          
          function moveMarkerEvent(event) {
                lat = event.latLng.lat();
                lng = event.latLng.lng();
                initMap();        
          }
          
          function createSelectForTime(id, minimum,maximum) {
            
            var minimum = parseInt(minimum);
            var maximum = parseInt(maximum);
            
            var selectString = '<select id="timeSelect'+id+'">'
                    
            
            for (var i = minimum; i <= maximum; i+= 10) {
                selectString += '<option value="'+i+'">'+i+'</option>'
                if((i+10) > maximum)
                    '<option value="'+maximum+'">'+maximum+'</option>'
            }
            selectString += '</select>';
            return selectString;
          }
        </script>
      
        
                <script src="js/plugins.js"></script>
        <script src="js/main.js"></script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDsiKM9luGA43--SjVxK2PAuMiiTg6teMs&callback=initMap"
        async defer></script>  
        
        <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
        <script>
            var _gaq=[['_setAccount','UA-XXXXX-X'],['_trackPageview']];
            (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
            g.src='//www.google-analytics.com/ga.js';
            s.parentNode.insertBefore(g,s)}(document,'script'));
        </script>
    </body>
</html>
